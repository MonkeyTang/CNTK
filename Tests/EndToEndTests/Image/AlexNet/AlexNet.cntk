ModelDir = "$RunDir$/models"

ndlMacros=$ConfigDir$/Macros.ndl

precision=float
deviceId=Auto

command=Train:AddTop5Eval:Test

parallelTrain=false

traceLevel=1
numMBsToShowResult=100

Train=[
    action=train
    modelPath=$ModelDir$/AlexNet

    NDLNetworkBuilder=[
        networkDescription=$ConfigDir$/AlexNet.ndl
    ]
    
    SGD=[
        epochSize=0
        minibatchSize=16
        learningRatesPerMB=0.01*20:0.003*12:0.001*28:0.0003
        momentumPerMB=0.9
        maxEpochs=3
        gradUpdateType=None
        L2RegWeight=0.0005
        dropoutRate=0*5:0.5
        
        ParallelTrain=[
            parallelizationMethod=DataParallelSGD
            distributedMBReading=true
            parallelizationStartEpoch=1
            DataParallelSGD=[
                gradientBits=1
            ]
        ]
        
        numMBsToShowResult=100
    ]

    reader = [
        verbosity = 0
        randomize = true
        useLegacy = false

        # A list of deserializers to use.
        deserializers = [
            [   
                type = "ImageDataDeserializer"        
                module = "ImageReader"

                # Map file which maps images to labels using the following format:
                # <full path to image><tab><numerical label (0-based class id)>
                # Example:
                # C:\Data\ImageNet\2012\train\n01440764\n01440764_10026.JPEG<tab>0
                file=$ConfigDir$/train_map.txt

                # Description of input streams
                inputs = [
                    features=[
                        transforms=[
                            [
                                type="Crop"
                                cropType=Random
                                cropRatio=0.875
                                jitterType=UniRatio
                            ]:[
                                type="Scale"
                                width=224
                                height=224
                                channels=3
                                interpolations=Linear
                            ]:[
                                type="Mean"
                                meanFile=$ConfigDir$/ImageNet1K_mean.xml
                            ]:[
                                type="Transpose"
                            ]
                        ]
                    ]
                    labels=[
                        labelDim=1000
                    ]
                ]
            ]
        ]
    ]    
]

AddTop5Eval=[    
    action=edit
    CurModel=$ModelDir$/AlexNet
    NewModel=$ModelDir$/AlexNet.Top5
    editPath=$ConfigDir$/add_top5_layer.mel
]

Test=[
    action=test
    modelPath=$ModelDir$/AlexNet.Top5
    # Set minibatch size for testing.
    minibatchSize=16

     NDLNetworkBuilder=[
        networkDescription=$ConfigDir$/AlexNet.ndl
    ]
    
    reader=[
        readerType=ImageReader
        file=$ConfigDir$/val_map.txt
        randomize=None
        features=[
            width=224
            height=224
            channels=3
            cropType=Center
            meanFile=$ConfigDir$/ImageNet1K_mean.xml
        ]
        labels=[
            labelDim=1000
        ]
    ]    
]
